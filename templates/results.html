<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Results for '{{ keyword }}'</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    body, html { margin:0; padding:0; }
    .main-flex { display: flex; height: 85vh; }
    #map { flex: 2; min-width: 350px; height: 100%; }
    #side-panel { flex: 1; min-width: 350px; max-width: 500px; overflow-y: auto; background: #fafafa; border-left: 1px solid #eee; }
    .sort-controls { margin: 16px; display: flex; gap: 10px; justify-content: flex-end; }
    .sort-controls button { padding: 8px 12px; border: 1px solid #4285F4; background: #fff; color: #4285F4; border-radius: 4px; cursor: pointer; }
    .sort-controls button.active, .sort-controls button:hover { background: #4285F4; color: #fff; }
    #places-list { list-style: none; padding: 0; margin: 0; }
    #places-list li { padding: 12px; border-bottom: 1px solid #ddd; cursor: pointer; }
    .place-info strong { font-size: 1.05em; }
    .search-container { padding: 18px; display: flex; justify-content: center; background: #fff; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { padding: 8px 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; }
    .search-box button { padding: 8px 16px; font-size: 14px; background: #4285F4; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .search-box button:hover { background: #357ae8; }
  </style>
</head>
<body>
<div class="search-container">
  <form class="search-box" action="/results" method="get">
    <input id="location-input" name="location" type="text" value="{{ location_text }}" required>
    <input id="keyword-input" name="keyword" type="text" value="{{ keyword }}" required>
    <button type="submit">Search</button>
  </form>
</div>

<div class="main-flex">
  <div id="map"></div>
  <div id="side-panel">
    <div class="sort-controls">
      <button onclick="sortBy('reviews')">Sort by Reviews</button>
      <button onclick="sortBy('rating')">Sort by Rating</button>
    </div>
    <ul id="places-list">
      {% for p in places %}
      <li data-idx="{{ loop.index0 }}" onclick="openMarker({{ loop.index0 }})">
        <div class="place-info">
          <strong>{{ loop.index }}. {{ p.name }}</strong><br>
          <small>Rating: {{ p.rating or 'N/A' }} ({{ p.user_ratings_total or 0 }} reviews)</small><br>
          <small>{{ p.vicinity }}</small>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ browser_key }}&libraries=places"></script>
<script>
  let map, markers = [], infoWindow = null, openedIdx = null;
  window.placesAll = {{ places|tojson }};

  function initMap() {
    const center = {{ center_json|safe }};
    map = new google.maps.Map(document.getElementById('map'), { center, zoom: 13 });
    addMarkers(window.placesAll);
    map.addListener("click", () => { if(infoWindow) infoWindow.close(); openedIdx = null; });
  }

  function addMarkers(places) {
    markers.forEach(m => m.setMap(null));
    markers = [];

    places.forEach((p, i) => {
      if (!p.geometry) return;
      const marker = new google.maps.Marker({
        position: p.geometry.location,
        map,
        label: { text: `${i+1}`, color: "#fff", fontSize: "14px", fontWeight: "bold" },
        title: p.name
      });
      marker.addListener('click', () => {
        openInfoWindow(p, marker, i);
        map.panTo(marker.getPosition());
        openedIdx = i;
      });
      markers.push(marker);
    });
  }

  function openMarker(idx) {
    const marker = markers[idx];
    if (openedIdx === idx && infoWindow) {
      infoWindow.close();
      openedIdx = null;
    } else {
      openInfoWindow(window.placesAll[idx], marker, idx);
      if(openedIdx !== idx){
        map.panTo(marker.getPosition());
      }
      openedIdx = idx;
    }
  }

  function openInfoWindow(p, marker, idx) {
    if (infoWindow) infoWindow.close();
    const imgTag = p.photos?.length
            ? `<img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=640&photoreference=${p.photos[0].photo_reference}&key={{ browser_key }}" style="width:350px;height:200px;object-fit:cover;border-radius:8px;margin-bottom:8px;">`
            : '';
    infoWindow = new google.maps.InfoWindow({
      content: `
      <div style="max-width:400px;">
        ${imgTag}
        <strong>${p.name}</strong><br>
        Rating: ${p.rating || 'N/A'} (${p.user_ratings_total || 0} reviews)<br>
        <small>${p.vicinity || ''}</small>
      </div>`,
      disableAutoPan: true
    });
    infoWindow.open(map, marker);
  }

  function sortBy(key) {
    const ul = document.getElementById('places-list');
    const sortedItems = Array.from(ul.children).sort((a,b) => (
            (parseFloat(b.dataset[key]) || 0) - (parseFloat(a.dataset[key]) || 0)
    ));

    sortedItems.forEach((item, idx) => {
      ul.appendChild(item);
      item.querySelector('.place-info strong').innerHTML = `${idx+1}. ${item.querySelector('.place-info strong').innerHTML.replace(/^\d+\.\s*/, '')}`;
    });

    window.placesAll = sortedItems.map(item => window.placesAll[item.dataset.idx]);
    addMarkers(window.placesAll);
    openedIdx = null;
  }

  function attachAutocomplete() {
    const input = document.getElementById('location-input');
    if (!input.getAttribute('data-autocomplete')) {
      new google.maps.places.Autocomplete(input, { types: ['(cities)'] });
      input.setAttribute('data-autocomplete', 'true');
    }
  }

  window.onload = () => { attachAutocomplete(); initMap(); };
</script>
</body>
</html>
