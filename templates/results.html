<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Results for '{{ keyword }}'</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .search-container { padding: 20px; background: #fff; display: flex; justify-content: center; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { padding: 8px 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; }
    .search-box button { padding: 8px 16px; font-size: 14px; background: #4285F4; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .search-box button:hover { background: #357ae8; }
    .sort-controls { margin: 16px; display: flex; gap: 10px; justify-content: center; }
    .sort-controls button { padding: 8px 12px; border: 1px solid #4285F4; background: #fff; color: #4285F4; border-radius: 4px; cursor: pointer; }
    .sort-controls button.active, .sort-controls button:hover { background: #4285F4; color: #fff; }
    #map { width: 100%; height: 60vh; }
    #place-list { padding: 16px; max-height: 30vh; overflow-y: auto; background: #fafafa; }
    #place-list ul { list-style: none; padding: 0; margin: 0; }
    #place-list li { padding: 12px 0; border-bottom: 1px solid #ddd; }
    #place-list li:last-child { border: none; }
  </style>
</head>
<body>
<div class="search-container">
  <form class="search-box" action="/results" method="get">
    <input id="location-input" name="location" type="text" value="{{ location_text }}" required>
    <input id="keyword-input" name="keyword" type="text" value="{{ keyword }}" required>
    <button type="submit">Search</button>
  </form>
</div>
<div id="map"></div>
<div class="sort-controls">
  <button id="sort-reviews" onclick="sortBy('reviews');return false;">Sort by Reviews</button>
  <button id="sort-rating" onclick="sortBy('rating');return false;">Sort by Rating</button>
</div>
<div id="place-list">
  <ul id="places-list">
    {% for p in places %}
    <li data-idx="{{ loop.index0 }}" data-reviews="{{ p.user_ratings_total or 0 }}" data-rating="{{ p.rating or 0 }}">
      <strong>{{ loop.index }}. {{ p.name }}</strong><br>
      <small>Rating: {{ p.rating or 'N/A' }} ({{ p.user_ratings_total or 0 }} reviews)</small><br>
      <small>{{ p.vicinity }}</small>
    </li>
    {% endfor %}
  </ul>
</div>

<script src = "https://maps.googleapis.com/maps/api/js?key={{ browser_key }}&libraries=places"></script>
<script>
  let map;
  let markers = [];
  let autocompleteInstance = null;
  window.placesAll = {{ places|tojson }};

  let searching = false;

  function attachAutocomplete() {
    var input = document.getElementById('location-input');
    if (input && !input.hasAttribute('data-autocomplete')) {
      autocompleteInstance = new google.maps.places.Autocomplete(input, { types: ['(cities)'] });
      input.setAttribute('data-autocomplete', 'true');
    }
  }

  function initMap() {
    var center = {{ center_json|safe }};
    map = new google.maps.Map(document.getElementById('map'), { center: center, zoom: 13 });
    addMarkers(window.placesAll);

    map.addListener('idle', function() {
      if (searching) return;
      searching = true;
      const c = map.getCenter();
      fetch('/map_search', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          lat: c.lat(),
          lng: c.lng(),
          keyword: document.getElementById('keyword-input').value
        })
      })
              .then(res => res.json())
              .then(data => {
                window.placesAll = data.places;
                renderPlaceList(data.places);
                addMarkers(data.places);
                searching = false;
              })
              .catch(()=>{ searching = false; });
    });
  }

  function addMarkers(places) {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    for (let i = 0; i < places.length; i++) {
      let p = places[i];
      if (!p.geometry) continue;
      let latLng = {lat: p.geometry.location.lat, lng: p.geometry.location.lng};
      let marker = new google.maps.Marker({
        position: latLng,
        map: map,
        label: {
          text: String(i + 1),
          color: "#fff",
          fontWeight: "bold",
          fontSize: "14px"
        },
        title: p.name
      });
      let infoWindow = new google.maps.InfoWindow({
        content: `<div style="min-width:140px; padding:2px 8px 2px 8px; margin:0;">
        <strong style="margin:0; padding:0;">${i+1}. ${p.name}</strong><br>
        Rating: ${p.rating || 'N/A'} (${p.user_ratings_total || 0} reviews)<br>
        <small>${p.vicinity || ''}</small>
      </div>`
      });
      marker.addListener('mouseover', function() { infoWindow.open(map, marker); });
      marker.addListener('mouseout', function() { infoWindow.close(); });
      markers.push(marker);
    }
  }

  function renderPlaceList(places) {
    const ul = document.getElementById('places-list');
    ul.innerHTML = "";
    for (let i = 0; i < places.length; i++) {
      const p = places[i];
      const li = document.createElement('li');
      li.setAttribute('data-idx', i);
      li.setAttribute('data-reviews', p.user_ratings_total || 0);
      li.setAttribute('data-rating', p.rating || 0);
      li.innerHTML = `<strong>${i + 1}. ${p.name}</strong><br>
      <small>Rating: ${p.rating || 'N/A'} (${p.user_ratings_total || 0} reviews)</small><br>
      <small>${p.vicinity || ''}</small>`;
      ul.appendChild(li);
    }
  }

  function sortBy(key) {
    var ul = document.getElementById('places-list');
    var items = Array.from(ul.children);
    items.sort(function(a, b) {
      var aVal = parseFloat(a.dataset[key]) || 0;
      var bVal = parseFloat(b.dataset[key]) || 0;
      return bVal - aVal;
    });
    items.forEach(function(item, idx) {
      ul.appendChild(item);
      var strong = item.querySelector('strong');
      if (strong) {
        let oldText = strong.innerHTML;
        let name = oldText.replace(/^\d+\.\s*/, '');
        strong.innerHTML = (idx+1) + ". " + name;
      }
    });
    let sortedPlaces = [];
    items.forEach(function(item) {
      let idx = item.getAttribute('data-idx');
      sortedPlaces.push(window.placesAll[idx]);
    });
    addMarkers(sortedPlaces);
    document.getElementById('sort-reviews').classList.toggle('active', key === 'reviews');
    document.getElementById('sort-rating').classList.toggle('active', key === 'rating');
  }

  window.onload = function() {
    attachAutocomplete();
    initMap();
  }
</script>
</body>
</html>
